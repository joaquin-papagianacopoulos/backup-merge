<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MiNegocio ‚Äî Merge de Backups</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
<style>
  :root {
    --bg: #0a0a0f; --surface: #12121a; --card: #1a1a26; --border: #2a2a40;
    --accent: #6c63ff; --accent2: #ff6584; --accent3: #43d9ad;
    --text: #e8e8f0; --muted: #666680;
    --success: #43d9ad; --warn: #ffb347; --danger: #ff6584;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Syne', sans-serif; min-height: 100vh; overflow-x: hidden; }
  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: linear-gradient(rgba(108,99,255,0.04) 1px,transparent 1px), linear-gradient(90deg,rgba(108,99,255,0.04) 1px,transparent 1px);
    background-size: 40px 40px; pointer-events: none; z-index: 0;
  }
  .glow-orb { position: fixed; width: 600px; height: 600px; border-radius: 50%; filter: blur(120px); pointer-events: none; z-index: 0; }
  .glow-orb-1 { background: rgba(108,99,255,0.12); top: -200px; left: -100px; }
  .glow-orb-2 { background: rgba(255,101,132,0.08); bottom: -200px; right: -100px; }
  .container { position: relative; z-index: 1; max-width: 960px; margin: 0 auto; padding: 40px 24px 80px; }

  header { display: flex; align-items: flex-start; gap: 20px; margin-bottom: 56px; }
  .logo-mark { width: 52px; height: 52px; background: linear-gradient(135deg,var(--accent),var(--accent2)); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; box-shadow: 0 0 30px rgba(108,99,255,0.4); }
  .header-text h1 { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; line-height: 1.1; }
  .header-text h1 span { background: linear-gradient(135deg,var(--accent),var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .header-text p { font-family: 'DM Mono',monospace; font-size: 12px; color: var(--muted); margin-top: 6px; letter-spacing: 0.5px; }

  .steps { display: flex; margin-bottom: 48px; position: relative; }
  .steps::before { content: ''; position: absolute; top: 20px; left: 20px; right: 20px; height: 1px; background: var(--border); z-index: 0; }
  .step { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; position: relative; z-index: 1; }
  .step-num { width: 40px; height: 40px; border-radius: 50%; background: var(--surface); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; transition: all 0.3s; font-family: 'DM Mono',monospace; }
  .step.active .step-num { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 20px rgba(108,99,255,0.5); }
  .step.done .step-num { background: var(--accent3); border-color: var(--accent3); color: var(--bg); }
  .step-label { font-size: 11px; color: var(--muted); font-family: 'DM Mono',monospace; letter-spacing: 0.5px; text-align: center; }
  .step.active .step-label { color: var(--text); }

  .drop-zone { border: 2px dashed var(--border); border-radius: 20px; padding: 56px 32px; text-align: center; cursor: pointer; transition: all 0.3s; background: var(--surface); position: relative; overflow: hidden; }
  .drop-zone::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse at center,rgba(108,99,255,0.06) 0%,transparent 70%); opacity: 0; transition: opacity 0.3s; }
  .drop-zone:hover, .drop-zone.dragover { border-color: var(--accent); box-shadow: 0 0 40px rgba(108,99,255,0.15); }
  .drop-zone:hover::before, .drop-zone.dragover::before { opacity: 1; }
  .drop-icon { font-size: 48px; margin-bottom: 16px; display: block; animation: float 3s ease-in-out infinite; }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }
  .drop-zone h3 { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
  .drop-zone p { color: var(--muted); font-family: 'DM Mono',monospace; font-size: 12px; }
  .drop-zone input { display: none; }

  .file-list { display: flex; flex-direction: column; gap: 10px; margin-top: 24px; }
  .file-item { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px 20px; display: flex; align-items: center; gap: 14px; animation: slideIn 0.3s ease; position: relative; overflow: hidden; }
  .file-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: var(--accent); }
  .file-item.base-file::before { background: var(--accent3); }
  @keyframes slideIn { from{opacity:0;transform:translateX(-10px)} to{opacity:1;transform:translateX(0)} }
  .file-icon { width: 40px; height: 40px; background: rgba(108,99,255,0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
  .file-info { flex: 1; min-width: 0; }
  .file-name { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .file-meta { font-family: 'DM Mono',monospace; font-size: 11px; color: var(--muted); margin-top: 2px; }
  .file-badge { font-family: 'DM Mono',monospace; font-size: 10px; padding: 3px 10px; border-radius: 20px; white-space: nowrap; }
  .badge-base { background: rgba(67,217,173,0.15); color: var(--accent3); }
  .badge-src { background: rgba(108,99,255,0.15); color: #a89dff; }
  .remove-btn { width: 28px; height: 28px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s; flex-shrink: 0; }
  .remove-btn:hover { border-color: var(--danger); color: var(--danger); background: rgba(255,101,132,0.1); }

  .config-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 28px; margin-top: 32px; }
  .config-panel h3 { font-size: 16px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
  .config-panel h3::before { content: ''; display: block; width: 8px; height: 8px; border-radius: 50%; background: var(--accent); }
  .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  @media (max-width: 600px) { .config-grid { grid-template-columns: 1fr; } }
  .toggle-row { display: flex; align-items: center; justify-content: space-between; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 14px 16px; cursor: pointer; transition: all 0.2s; user-select: none; }
  .toggle-row:hover { border-color: var(--accent); }
  .toggle-row.checked { border-color: rgba(108,99,255,0.4); background: rgba(108,99,255,0.05); }
  .toggle-label { font-size: 13px; font-weight: 600; }
  .toggle-sub { font-family: 'DM Mono',monospace; font-size: 10px; color: var(--muted); margin-top: 2px; }
  .toggle-switch { width: 36px; height: 20px; background: var(--border); border-radius: 10px; position: relative; transition: background 0.2s; flex-shrink: 0; }
  .toggle-row.checked .toggle-switch { background: var(--accent); }
  .toggle-switch::after { content: ''; position: absolute; width: 14px; height: 14px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: transform 0.2s; }
  .toggle-row.checked .toggle-switch::after { transform: translateX(16px); }
  .info-box { margin-top: 16px; background: var(--card); border: 1px solid rgba(255,179,71,0.3); border-radius: 12px; padding: 14px 16px; font-family: 'DM Mono',monospace; font-size: 11px; color: var(--warn); line-height: 1.7; }

  .action-area { margin-top: 32px; display: flex; gap: 12px; flex-wrap: wrap; }
  .btn { padding: 14px 28px; border-radius: 12px; border: none; font-family: 'Syne',sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.25s; display: flex; align-items: center; gap: 8px; }
  .btn-primary { background: linear-gradient(135deg,var(--accent),#8b7cf6); color: white; box-shadow: 0 4px 20px rgba(108,99,255,0.35); }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(108,99,255,0.5); }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .btn-secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--accent); }

  .log-panel { margin-top: 32px; background: var(--surface); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; display: none; }
  .log-panel.visible { display: block; animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
  .progress-bar { height: 3px; background: var(--border); }
  .progress-fill { height: 100%; background: linear-gradient(90deg,var(--accent),var(--accent2)); transition: width 0.3s; width: 0%; }
  .log-header { padding: 14px 20px; background: var(--card); border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
  .log-spinner { width: 14px; height: 14px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
  .log-spinner.active { display: block; }
  @keyframes spin { to{transform:rotate(360deg)} }
  .log-body { padding: 16px 20px; font-family: 'DM Mono',monospace; font-size: 12px; line-height: 1.8; max-height: 320px; overflow-y: auto; }
  .log-line { display: flex; gap: 12px; }
  .log-time { color: var(--muted); flex-shrink: 0; }
  .log-msg.ok   { color: var(--success); }
  .log-msg.warn { color: var(--warn); }
  .log-msg.err  { color: var(--danger); }
  .log-msg.info { color: var(--text); }

  .result-panel { margin-top: 32px; background: linear-gradient(135deg,rgba(67,217,173,0.05),rgba(108,99,255,0.05)); border: 1px solid rgba(67,217,173,0.3); border-radius: 20px; padding: 28px; display: none; }
  .result-panel.visible { display: block; animation: fadeIn 0.4s ease; }
  .result-title { font-size: 18px; font-weight: 800; color: var(--accent3); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(130px,1fr)); gap: 12px; margin-bottom: 24px; }
  .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 14px 16px; text-align: center; }
  .stat-num { font-size: 24px; font-weight: 800; font-family: 'DM Mono',monospace; color: var(--accent); }
  .stat-label { font-size: 11px; color: var(--muted); margin-top: 4px; font-family: 'DM Mono',monospace; }
  .btn-download { background: linear-gradient(135deg,var(--accent3),#2cb88a); color: var(--bg); padding: 14px 32px; font-size: 15px; box-shadow: 0 4px 20px rgba(67,217,173,0.3); }
  .btn-download:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(67,217,173,0.45); }

  ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: var(--surface); } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; } ::-webkit-scrollbar-thumb:hover { background: var(--accent); }
</style>
</head>
<body>
<div class="glow-orb glow-orb-1"></div>
<div class="glow-orb glow-orb-2"></div>
<div class="container">
  <header>
    <div class="logo-mark">üóÑÔ∏è</div>
    <div class="header-text">
      <h1>MiNegocio <span>Backup Merge</span></h1>
      <p>// Combina m√∫ltiples backups .mn en uno solo</p>
    </div>
  </header>

  <div class="steps">
    <div class="step active" id="step1"><div class="step-num">01</div><div class="step-label">Cargar archivos</div></div>
    <div class="step" id="step2"><div class="step-num">02</div><div class="step-label">Configurar</div></div>
    <div class="step" id="step3"><div class="step-num">03</div><div class="step-label">Resultado</div></div>
  </div>

  <div class="drop-zone" id="dropZone">
    <span class="drop-icon">üì¶</span>
    <h3>Arrastr√° tus archivos .mn aqu√≠</h3>
    <p>o hac√© click para seleccionarlos ¬∑ m√≠nimo 2 archivos</p>
    <input type="file" id="fileInput" accept=".mn" multiple>
  </div>

  <div class="file-list" id="fileList"></div>

  <div class="config-panel" id="configPanel" style="display:none">
    <h3>¬øQu√© datos combinar?</h3>
    <div class="config-grid">
      <div class="toggle-row checked" onclick="toggleOpt(this,'opt_clientes')">
        <div><div class="toggle-label">üë• Clientes</div><div class="toggle-sub">Fusiona base de clientes</div></div>
        <div class="toggle-switch"></div>
      </div>
      <div class="toggle-row checked" onclick="toggleOpt(this,'opt_ventas')">
        <div><div class="toggle-label">üßæ Ventas</div><div class="toggle-sub">Une historial de ventas</div></div>
        <div class="toggle-switch"></div>
      </div>
      <div class="toggle-row checked" onclick="toggleOpt(this,'opt_productos')">
        <div><div class="toggle-label">üì¶ Productos</div><div class="toggle-sub">Combina inventario</div></div>
        <div class="toggle-switch"></div>
      </div>
      <div class="toggle-row checked" onclick="toggleOpt(this,'opt_categorias')">
        <div><div class="toggle-label">üè∑Ô∏è Categor√≠as</div><div class="toggle-sub">Une categor√≠as √∫nicas</div></div>
        <div class="toggle-switch"></div>
      </div>
      <div class="toggle-row checked" onclick="toggleOpt(this,'opt_compras')">
        <div><div class="toggle-label">üõí Compras</div><div class="toggle-sub">Historial de compras</div></div>
        <div class="toggle-switch"></div>
      </div>
      <div class="toggle-row checked" onclick="toggleOpt(this,'opt_imagenes')">
        <div><div class="toggle-label">üñºÔ∏è Im√°genes</div><div class="toggle-sub">Fotos de productos</div></div>
        <div class="toggle-switch"></div>
      </div>
    </div>
    <div class="info-box">
      ‚ö° <strong>C√≥mo funciona:</strong> El <strong>primer archivo</strong> de la lista es la BASE (se mantienen todos sus datos intactos). Los dem√°s se fusionan encima: se agregan solo los registros que no existen en la base. Los IDs se remuneran autom√°ticamente para evitar colisiones.
    </div>
  </div>

  <div class="action-area" id="actionArea" style="display:none">
    <button class="btn btn-primary" id="mergeBtn" onclick="startMerge()">‚ö° Ejecutar Merge</button>
    <button class="btn btn-secondary" onclick="clearAll()">üóë Limpiar todo</button>
  </div>

  <div class="log-panel" id="logPanel">
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="log-header"><div class="log-spinner" id="logSpinner"></div><span id="logTitle">Procesando...</span></div>
    <div class="log-body" id="logBody"></div>
  </div>

  <div class="result-panel" id="resultPanel">
    <div class="result-title">‚úÖ Merge completado con √©xito</div>
    <div class="stats-grid" id="statsGrid"></div>
    <button class="btn btn-primary btn-download" id="downloadBtn">‚¨á Descargar backup_merge.mn</button>
  </div>
</div>

<script>
let SQL = null;
let loadedFiles = [];
let mergedBlob = null;
const opts = { opt_clientes:true, opt_ventas:true, opt_productos:true, opt_categorias:true, opt_compras:true, opt_imagenes:true };

initSqlJs({ locateFile: f => f })
  .then(s => { SQL = s; })
  .catch(e => alert('Error cargando sql.js: ' + e.message));

function toggleOpt(el, key) { el.classList.toggle('checked'); opts[key] = el.classList.contains('checked'); }

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => { addFiles([...e.target.files]); e.target.value=''; });
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); addFiles([...e.dataTransfer.files].filter(f=>f.name.endsWith('.mn'))); });

async function addFiles(newFiles) {
  for (const file of newFiles) {
    if (loadedFiles.find(f=>f.name===file.name)) { log(`"${file.name}" ya est√° en la lista`,'warn'); continue; }
    const buf = await file.arrayBuffer();
    loadedFiles.push({ name:file.name, size:file.size, buf });
  }
  renderFileList(); updateUI();
}

function renderFileList() {
  document.getElementById('fileList').innerHTML = loadedFiles.map((f,i) => `
    <div class="file-item${i===0?' base-file':''}">
      <div class="file-icon">üì¶</div>
      <div class="file-info">
        <div class="file-name">${f.name}</div>
        <div class="file-meta">${(f.size/1024).toFixed(0)} KB</div>
      </div>
      <div class="file-badge ${i===0?'badge-base':'badge-src'}">${i===0?'‚ú¶ BASE':'+ FUENTE'}</div>
      <button class="remove-btn" onclick="removeFile(${i})">√ó</button>
    </div>`).join('');
}

function removeFile(i) { loadedFiles.splice(i,1); renderFileList(); updateUI(); }
function clearAll() {
  loadedFiles=[]; renderFileList();
  document.getElementById('logPanel').classList.remove('visible');
  document.getElementById('resultPanel').classList.remove('visible');
  document.getElementById('progressFill').style.width='0%';
  updateUI();
}
function updateUI() {
  const has = loadedFiles.length>=1;
  document.getElementById('configPanel').style.display = has?'block':'none';
  document.getElementById('actionArea').style.display = has?'flex':'none';
  setStep(has?2:1);
}
function setStep(n) {
  for(let i=1;i<=3;i++){
    const el=document.getElementById(`step${i}`);
    el.classList.remove('active','done');
    if(i<n) el.classList.add('done');
    if(i===n) el.classList.add('active');
  }
}

let logLines=[];
function log(msg,type='info') {
  document.getElementById('logPanel').classList.add('visible');
  const t=new Date().toLocaleTimeString('es',{hour12:false});
  logLines.push(`<div class="log-line"><span class="log-time">${t}</span><span class="log-msg ${type}">${msg}</span></div>`);
  const body=document.getElementById('logBody');
  body.innerHTML=logLines.join('');
  body.scrollTop=body.scrollHeight;
}
function setProgress(p){ document.getElementById('progressFill').style.width=p+'%'; }

function queryRows(db,sql,params=[]){
  try{ const r=db.exec(sql,params); return(r.length&&r[0].values)?r[0].values:[]; }catch(e){return[];}
}
function queryOne(db,sql,params=[]){
  const r=queryRows(db,sql,params); return r.length?r[0][0]:null;
}

async function startMerge(){
  if(!SQL){ alert('sql.js a√∫n cargando, esper√° un momento.'); return; }
  if(loadedFiles.length<2){ alert('Necesit√°s al menos 2 archivos .mn para hacer un merge.'); return; }
  document.getElementById('mergeBtn').disabled=true;
  logLines=[];
  document.getElementById('logPanel').classList.add('visible');
  document.getElementById('resultPanel').classList.remove('visible');
  document.getElementById('logSpinner').classList.add('active');
  document.getElementById('logTitle').textContent='Procesando backups...';
  setProgress(0);
  try{
    const stats=await runMerge();
    document.getElementById('logSpinner').classList.remove('active');
    document.getElementById('logTitle').textContent='‚úì Completado';
    setStep(3); showResult(stats);
  }catch(e){
    log('ERROR FATAL: '+e.message,'err');
    console.error(e);
    document.getElementById('logSpinner').classList.remove('active');
    document.getElementById('logTitle').textContent='‚úó Error';
  }
  document.getElementById('mergeBtn').disabled=false;
}

async function runMerge(){
  const stats={clientes:0,ventas:0,venta_producto:0,productos:0,categorias:0,compras:0,imagenes:0};

  // Load base (first file)
  log(`Cargando BASE: ${loadedFiles[0].name}`,'info');
  const baseZip=await JSZip.loadAsync(loadedFiles[0].buf);
  const baseDbBytes=await baseZip.file('BD_MiNegocio').async('uint8array');
  const baseDb=new SQL.Database(baseDbBytes);
  setProgress(8);
  log('  BASE cargada ‚úì','ok');

  // Images from base
  const allImages={};
  if(opts.opt_imagenes){
    for(const fname of Object.keys(baseZip.files)){
      if(/\.(jpe?g|png|gif|webp)$/i.test(fname)){
        allImages[fname]=await baseZip.file(fname).async('uint8array');
        stats.imagenes++;
      }
    }
  }

  // Process each source file
  for(let fi=1;fi<loadedFiles.length;fi++){
    const f=loadedFiles[fi];
    setProgress(8+(78/(loadedFiles.length-1))*fi);
    log(`\nProcesando [${fi}/${loadedFiles.length-1}]: ${f.name}`,'info');

    const srcZip=await JSZip.loadAsync(f.buf);
    const srcDbBytes=await srcZip.file('BD_MiNegocio').async('uint8array');
    const srcDb=new SQL.Database(srcDbBytes);

    // Images
    if(opts.opt_imagenes){
      let n=0;
      for(const fname of Object.keys(srcZip.files)){
        if(/\.(jpe?g|png|gif|webp)$/i.test(fname)&&!allImages[fname]){
          allImages[fname]=await srcZip.file(fname).async('uint8array');
          n++; stats.imagenes++;
        }
      }
      if(n>0) log(`  +${n} im√°genes nuevas`,'ok');
    }

    // === CLIENTES ===
    // Build name->folio map of base
    const clienteFolioMap={}; // srcFolio -> baseFolio
    if(opts.opt_clientes){
      let maxFolio=queryOne(baseDb,'SELECT MAX(folio) FROM cliente')||0;
      const nameToFolio={};
      for(const[folio,nombre] of queryRows(baseDb,'SELECT folio,nombre_cliente FROM cliente'))
        nameToFolio[(nombre||'').trim().toLowerCase()]=folio;

      const srcRows=queryRows(srcDb,'SELECT folio,nombre_cliente,alias,telefono1,correo,direccion,info_adicional FROM cliente');
      let ins=0;
      for(const row of srcRows){
        const[oldFolio,nombre,alias,tel,correo,dir,info]=row;
        const nk=(nombre||'').trim().toLowerCase();
        if(nameToFolio[nk]!==undefined){
          clienteFolioMap[oldFolio]=nameToFolio[nk];
        } else {
          maxFolio++;
          try{
            baseDb.run('INSERT INTO cliente(folio,nombre_cliente,alias,telefono1,correo,direccion,info_adicional)VALUES(?,?,?,?,?,?,?)',
              [maxFolio,nombre,alias,tel,correo,dir,info]);
            clienteFolioMap[oldFolio]=maxFolio;
            nameToFolio[nk]=maxFolio;
            ins++; stats.clientes++;
          }catch(e){ log('  cliente err: '+e.message,'warn'); }
        }
      }
      log(`  Clientes: +${ins} nuevos (${srcRows.length} procesados)`,ins>0?'ok':'info');
    }

    // === VENTAS ===
    const ventaFolioMap={};
    if(opts.opt_ventas){
      let maxVenta=queryOne(baseDb,'SELECT MAX(folio) FROM venta')||0;
      const ventaSet=new Set(queryRows(baseDb,'SELECT fecha,hora,total FROM venta').map(r=>`${r[0]}|${r[1]}|${r[2]}`));

      const srcVentas=queryRows(srcDb,'SELECT folio,fecha,total,hora,status,nombre_cliente,id_cliente,pagos,direccion,id_forma_pago,etiqueta FROM venta');
      let ins=0;
      for(const row of srcVentas){
        const[oldFolio,fecha,total,hora,status,nombre_cliente,id_cliente,pagos,direccion,id_forma_pago,etiqueta]=row;
        const dk=`${fecha}|${hora}|${total}`;
        if(!ventaSet.has(dk)){
          maxVenta++;
          const newIdCliente=clienteFolioMap[id_cliente]??id_cliente;
          try{
            baseDb.run('INSERT INTO venta(folio,fecha,total,hora,status,nombre_cliente,id_cliente,pagos,direccion,id_forma_pago,etiqueta)VALUES(?,?,?,?,?,?,?,?,?,?,?)',
              [maxVenta,fecha,total,hora,status,nombre_cliente,newIdCliente,pagos,direccion,id_forma_pago,etiqueta]);
            ventaFolioMap[oldFolio]=maxVenta;
            ventaSet.add(dk);
            ins++; stats.ventas++;
          }catch(e){ log('  venta err: '+e.message,'warn'); }
        }
      }
      log(`  Ventas: +${ins} nuevas (${srcVentas.length} procesadas)`,ins>0?'ok':'info');

      // venta_producto ‚Äî schema: folio,nombre,p_compra,p_venta,cantidad,subtotal,tipo
      const srcVP=queryRows(srcDb,'SELECT folio,nombre,p_compra,p_venta,cantidad,subtotal,tipo FROM venta_producto');
      let insVP=0;
      for(const row of srcVP){
        const newFolio=ventaFolioMap[row[0]];
        if(newFolio!==undefined){
          try{
            baseDb.run('INSERT INTO venta_producto(folio,nombre,p_compra,p_venta,cantidad,subtotal,tipo)VALUES(?,?,?,?,?,?,?)',
              [newFolio,row[1],row[2],row[3],row[4],row[5],row[6]]);
            insVP++; stats.venta_producto++;
          }catch(e){}
        }
      }
      if(insVP>0) log(`  Items de ventas: +${insVP}`,'ok');
    }

    // === PRODUCTOS ===
    // key=text PK, nombre=unique ‚Äî INSERT OR IGNORE: keep base version, don't overwrite
    if(opts.opt_productos){
      const srcProd=queryRows(srcDb,'SELECT key,nombre,cantidad,p_compra,p_venta,reserva,descripcion,precios_extra_venta,categoria FROM producto');
      let ins=0;
      for(const row of srcProd){
        try{
          baseDb.run('INSERT OR IGNORE INTO producto(key,nombre,cantidad,p_compra,p_venta,reserva,descripcion,precios_extra_venta,categoria)VALUES(?,?,?,?,?,?,?,?,?)',row);
          ins++;
        }catch(e){}
      }
      stats.productos+=ins;
      if(ins>0) log(`  Productos: +${ins} nuevos`,'ok');
    }

    // === CATEGORIAS ===
    if(opts.opt_categorias){
      let maxCat=queryOne(baseDb,'SELECT MAX(folio) FROM categorias')||0;
      const catSet=new Set(queryRows(baseDb,'SELECT nombre FROM categorias').map(r=>(r[0]||'').trim().toLowerCase()));
      let ins=0;
      for(const[,nombre] of queryRows(srcDb,'SELECT folio,nombre FROM categorias')){
        const nk=(nombre||'').trim().toLowerCase();
        if(!catSet.has(nk)){
          maxCat++;
          try{ baseDb.run('INSERT INTO categorias(folio,nombre)VALUES(?,?)',[maxCat,nombre]); catSet.add(nk); ins++; stats.categorias++; }catch(e){}
        }
      }
      if(ins>0) log(`  Categor√≠as: +${ins} nuevas`,'ok');
    }

    // === COMPRAS ===
    // No PK ‚Äî dedup by fecha+tipo+key
    if(opts.opt_compras){
      const compraSet=new Set(queryRows(baseDb,'SELECT fecha,tipo,key FROM compra').map(r=>`${r[0]}|${r[1]}|${r[2]}`));
      const srcC=queryRows(srcDb,'SELECT fecha,tipo,key,nombre,cantidad,p_compra,p_venta,reserva,cantidad_old,p_compra_old,p_venta_old,reserva_old FROM compra');
      let ins=0;
      for(const row of srcC){
        const dk=`${row[0]}|${row[1]}|${row[2]}`;
        if(!compraSet.has(dk)){
          try{ baseDb.run('INSERT INTO compra VALUES(?,?,?,?,?,?,?,?,?,?,?,?)',row); compraSet.add(dk); ins++; stats.compras++; }catch(e){}
        }
      }
      if(ins>0) log(`  Compras: +${ins} nuevas`,'ok');
    }

    srcDb.close();
    log(`‚úì ${f.name} mergeado`,'ok');
  }

  // Export
  setProgress(90);
  log('\nExportando BD...','info');
  const exportedBytes=baseDb.export();
  baseDb.close();

  log('Empaquetando .mn...','info');
  const outZip=new JSZip();
  outZip.file('BD_MiNegocio',exportedBytes);
  for(const[fname,data] of Object.entries(allImages)) outZip.file(fname,data);

  setProgress(96);
  const blob=await outZip.generateAsync({type:'blob',compression:'DEFLATE',compressionOptions:{level:6}});
  mergedBlob=blob;
  log(`\n‚úì Archivo generado: ${(blob.size/1024).toFixed(0)} KB`,'ok');
  setProgress(100);
  return stats;
}

function showResult(stats){
  document.getElementById('resultPanel').classList.add('visible');
  const items=[
    {label:'Clientes nuevos',val:stats.clientes,icon:'üë•'},
    {label:'Ventas nuevas',val:stats.ventas,icon:'üßæ'},
    {label:'Items de ventas',val:stats.venta_producto,icon:'üîñ'},
    {label:'Productos nuevos',val:stats.productos,icon:'üì¶'},
    {label:'Categor√≠as nuevas',val:stats.categorias,icon:'üè∑Ô∏è'},
    {label:'Compras nuevas',val:stats.compras,icon:'üõí'},
    {label:'Im√°genes totales',val:stats.imagenes,icon:'üñºÔ∏è'},
  ];
  document.getElementById('statsGrid').innerHTML=items.map(s=>`
    <div class="stat-card">
      <div style="font-size:22px;margin-bottom:6px">${s.icon}</div>
      <div class="stat-num">+${s.val}</div>
      <div class="stat-label">${s.label}</div>
    </div>`).join('');
  document.getElementById('downloadBtn').onclick=()=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(mergedBlob);
    a.download=`backup_merge_${new Date().toISOString().slice(0,10)}.mn`;
    a.click();
  };
}
</script>
</body>
</html>